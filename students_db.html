<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Database (IndexedDB)</title>
  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; max-width: 760px; margin: 28px auto; padding: 0 16px; }
    label { display: block; margin: 10px 0 6px; }
    input, select { padding: 8px 10px; font-size: 15px; width: 100%; box-sizing: border-box; }
    button { margin-top: 10px; padding: 8px 12px; font-size: 15px; }
    ul { margin-top: 18px; padding-left: 18px; }
    li { margin-bottom: 8px; }
    .small { font-size: 13px; color: #555; }
    .actions button { margin-left: 6px; }
  </style>
</head>
<body>
  <h1>Student Database (Browser)</h1>
  <p class="small">This page uses the browser's <strong>IndexedDB</strong> to save student data locally.</p>

  <label for="name">Name of student</label>
  <input id="name" placeholder="Name Of Student" type="text">

  <label for="classSelect">Choose your class</label>
  <select id="classSelect" name="class">
    <option value="">--Select--</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
    <option value="10">10</option>
  </select>

  <label for="email">Email</label>
  <input id="email" placeholder="Email" type="email">

  <div>
    <button id="saveBtn">Save</button>
    <button id="showBtn" type="button">Show All</button>
    <button id="clearBtn" type="button">Clear Form</button>
  </div>

  <ul id="studentList"></ul>

  <script>
    // ----------------------------
    // Simple IndexedDB helper and UI
    // ----------------------------

    let db;                 // global DB reference
    let editingId = null;   // if set, Save will update instead of add

    // Initialize (open) the database
    function initDB() {
      const request = indexedDB.open('students_db', 1);

      request.onupgradeneeded = function(event) {
        db = event.target.result;
        if (!db.objectStoreNames.contains('students')) {
          const store = db.createObjectStore('students', { keyPath: 'id', autoIncrement: true });
          store.createIndex('name', 'name', { unique: false });
          store.createIndex('class', 'class', { unique: false });
          store.createIndex('email', 'email', { unique: false });
        }
      };

      request.onsuccess = function(event) {
        db = event.target.result;
        console.log('IndexedDB opened:', db);
        displayStudents(); // show existing records on load
      };

      request.onerror = function(event) {
        console.error('Error opening DB:', event.target.error);
        alert('Could not open IndexedDB. Check console for details.');
      };
    }

    // Save or update student
    function saveStudent() {
      const name = document.getElementById('name').value.trim();
      const classVal = document.getElementById('classSelect').value;
      const email = document.getElementById('email').value.trim();

      if (!name || !classVal || !email) {
        alert('Please fill all fields.');
        return;
      }

      const tx = db.transaction('students', 'readwrite');
      const store = tx.objectStore('students');

      if (editingId) {
        // Update existing
        const updated = { id: Number(editingId), name, class: classVal, email };
        const req = store.put(updated);
        req.onsuccess = function() {
          editingId = null;
          document.getElementById('saveBtn').textContent = 'Save';
          clearForm();
          displayStudents();
        };
      } else {
        // Add new
        const req = store.add({ name, class: classVal, email });
        req.onsuccess = function() {
          clearForm();
          displayStudents();
        };
      }

      tx.oncomplete = function() { console.log('Transaction finished.'); };
      tx.onerror = function(e) { console.error('Transaction error:', e.target.error); };
    }

    // Display all students in the <ul>
    function displayStudents() {
      const list = document.getElementById('studentList');
      list.innerHTML = '';

      const tx = db.transaction('students', 'readonly');
      const store = tx.objectStore('students');
      const req = store.openCursor();

      req.onsuccess = function(event) {
        const cursor = event.target.result;
        if (cursor) {
          const s = cursor.value;

          const li = document.createElement('li');
          li.dataset.id = s.id;
          li.innerHTML = `\n            <strong>${escapeHtml(s.name)}</strong> (Class ${escapeHtml(s.class)}) - ${escapeHtml(s.email)}\n            <span class="actions">\n              <button data-action="edit">Edit</button>\n              <button data-action="delete">Delete</button>\n            </span>`;

          li.querySelector('[data-action="edit"]').addEventListener('click', () => editStudent(s.id));
          li.querySelector('[data-action="delete"]').addEventListener('click', () => deleteStudent(s.id));

          list.appendChild(li);
          cursor.continue();
        } else {
          if (!list.firstChild) list.innerHTML = '<li><em>No students found.</em></li>';
        }
      };

      req.onerror = function(e) { console.error('Cursor error:', e.target.error); };
    }

    // Fill the form to edit a student
    function editStudent(id) {
      const tx = db.transaction('students', 'readonly');
      const store = tx.objectStore('students');
      const req = store.get(id);

      req.onsuccess = function(e) {
        const s = e.target.result;
        document.getElementById('name').value = s.name;
        document.getElementById('classSelect').value = s.class;
        document.getElementById('email').value = s.email;
        editingId = s.id;
        document.getElementById('saveBtn').textContent = 'Update';
      };
    }

    // Delete student
    function deleteStudent(id) {
      if (!confirm('Delete this student?')) return;
      const tx = db.transaction('students', 'readwrite');
      const store = tx.objectStore('students');
      const req = store.delete(id);
      req.onsuccess = function() { displayStudents(); };
      req.onerror = function(e) { console.error('Delete error:', e.target.error); };
    }

    // Clear form
    function clearForm() {
      document.getElementById('name').value = '';
      document.getElementById('classSelect').value = '';
      document.getElementById('email').value = '';
      editingId = null;
      document.getElementById('saveBtn').textContent = 'Save';
    }

    // Very small helper to avoid simple HTML injection when showing values
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Wire buttons
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('saveBtn').addEventListener('click', saveStudent);
      document.getElementById('showBtn').addEventListener('click', displayStudents);
      document.getElementById('clearBtn').addEventListener('click', clearForm);
      initDB();
    });
  </script>
</body>
</html>
